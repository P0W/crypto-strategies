name: Strategy Regression Tests

on:
  push:
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'configs/**'
      - '.github/workflows/regression-tests.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'configs/**'
      - '.github/workflows/regression-tests.yml'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  regression-tests:
    name: ğŸ§ª Strategy Regression Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¦€ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: ğŸ“¦ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ”¨ Build release binary
        run: cargo build --release

      - name: ğŸ§ª Run strategy regression tests
        id: regression
        run: |
          STRATEGIES="regime_grid quick_flip momentum_scalper range_breakout volatility_regime"
          FAILED=""
          BETTER=""
          
          echo "## ğŸ“Š Strategy Regression Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for strategy in $STRATEGIES; do
            CONFIG="configs/${strategy}_config.json"
            echo "### ğŸ¯ ${strategy}" >> $GITHUB_STEP_SUMMARY
            echo "â±ï¸ Started: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
            
            set +e
            timeout 600 ./target/release/crypto-strategies optimize --config "$CONFIG" --top 1 > "/tmp/${strategy}_stdout.txt" 2> "/tmp/${strategy}_stderr.txt"
            EXIT_CODE=$?
            set -e
            
            echo "â±ï¸ Finished: $(date -u '+%Y-%m-%d %H:%M:%S UTC') | Exit: $EXIT_CODE" >> $GITHUB_STEP_SUMMARY
            
            # Show stderr if present
            if [ -s "/tmp/${strategy}_stderr.txt" ]; then
              echo "<details><summary>âš ï¸ Stderr</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              cat "/tmp/${strategy}_stderr.txt" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Show last 30 lines of output
            echo "<details><summary>ğŸ“‹ Output (last 30 lines)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 "/tmp/${strategy}_stdout.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            
            # Determine status
            if [ $EXIT_CODE -eq 124 ]; then
              echo "âŒ **TIMEOUT** (>10min)" >> $GITHUB_STEP_SUMMARY
              FAILED="$FAILED $strategy"
            elif [ $EXIT_CODE -ne 0 ]; then
              echo "âŒ **CRASHED** (exit $EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
              FAILED="$FAILED $strategy"
            elif grep -q "is already optimal" "/tmp/${strategy}_stdout.txt"; then
              echo "âœ… **PASSED** - config is already optimal" >> $GITHUB_STEP_SUMMARY
            elif grep -q "Config updated:" "/tmp/${strategy}_stdout.txt"; then
              echo "ğŸ”„ **BETTER CONFIG FOUND**" >> $GITHUB_STEP_SUMMARY
              BETTER="$BETTER $strategy"
            elif grep -q "No valid runs found" "/tmp/${strategy}_stdout.txt"; then
              echo "âŒ **NO VALID RUNS**" >> $GITHUB_STEP_SUMMARY
              FAILED="$FAILED $strategy"
            elif grep -q "Won't save a losing strategy" "/tmp/${strategy}_stdout.txt"; then
              echo "âŒ **NEGATIVE METRIC** - losing strategy" >> $GITHUB_STEP_SUMMARY
              FAILED="$FAILED $strategy"
            else
              echo "âŒ **UNEXPECTED OUTPUT**" >> $GITHUB_STEP_SUMMARY
              FAILED="$FAILED $strategy"
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
          done
          
          # Summary table
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“‹ Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Strategy | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          for strategy in $STRATEGIES; do
            if echo "$FAILED" | grep -qw "$strategy"; then
              echo "| $strategy | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            elif echo "$BETTER" | grep -qw "$strategy"; then
              echo "| $strategy | ğŸ”„ Better config |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $strategy | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          # Set outputs
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "better=$BETTER" >> $GITHUB_OUTPUT

      - name: ğŸ“ Commit better configs
        if: steps.regression.outputs.better != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BETTER="${{ steps.regression.outputs.better }}"
          for strategy in $BETTER; do
            git add "configs/${strategy}_config.json"
          done
          
          git commit -m "chore: auto-update optimized configs [skip ci]

          Updated strategies:$BETTER
          
          Triggered by: ${{ github.sha }}"
          git push

      - name: âŒ Fail if any regression test failed
        if: steps.regression.outputs.failed != ''
        run: |
          echo "::error::Regression tests failed for:${{ steps.regression.outputs.failed }}"
          exit 1

  lint-and-test:
    name: ğŸ” Lint & Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: ğŸ“¦ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ“ Check formatting
        run: cargo fmt --all -- --check

      - name: ğŸ” Run Clippy lints
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: ğŸ§ª Run unit tests
        run: cargo test --lib --verbose

      - name: ğŸ§ª Run integration tests
        run: cargo test --test '*' --verbose || true
