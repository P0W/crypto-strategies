name: Strategy Regression Tests

on:
  push:  # Run on any push
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  regression-tests:
    name: ğŸ§ª Strategy Regression Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: ğŸ¦€ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: ğŸ“¦ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ”¨ Build release binary
        run: cargo build --release

      - name: ğŸ§ª Run regime_grid regression test
        id: regime_grid
        run: |
          echo "## ğŸ¯ regime_grid Strategy" >> $GITHUB_STEP_SUMMARY
          OUTPUT=$(./target/release/crypto-strategies optimize --config configs/regime_grid_config.json --top 1 2>&1) || true
          echo '`' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '`' >> $GITHUB_STEP_SUMMARY
          if echo "$OUTPUT" | grep -q "already optimal"; then
            echo "âœ… regime_grid PASSED" >> $GITHUB_STEP_SUMMARY
            echo "regime_grid_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ regime_grid FAILED" >> $GITHUB_STEP_SUMMARY
            echo "regime_grid_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§ª Run quick_flip regression test
        id: quick_flip
        run: |
          echo "## ğŸ¯ quick_flip Strategy" >> $GITHUB_STEP_SUMMARY
          OUTPUT=$(./target/release/crypto-strategies optimize --config configs/quick_flip_config.json --top 1 2>&1) || true
          echo '`' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '`' >> $GITHUB_STEP_SUMMARY
          if echo "$OUTPUT" | grep -q "already optimal"; then
            echo "âœ… quick_flip PASSED" >> $GITHUB_STEP_SUMMARY
            echo "quick_flip_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ quick_flip FAILED" >> $GITHUB_STEP_SUMMARY
            echo "quick_flip_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§ª Run momentum_scalper regression test
        id: momentum_scalper
        run: |
          echo "## ğŸ¯ momentum_scalper Strategy" >> $GITHUB_STEP_SUMMARY
          OUTPUT=$(./target/release/crypto-strategies optimize --config configs/momentum_scalper_config.json --top 1 2>&1) || true
          echo '`' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '`' >> $GITHUB_STEP_SUMMARY
          if echo "$OUTPUT" | grep -q "already optimal"; then
            echo "âœ… momentum_scalper PASSED" >> $GITHUB_STEP_SUMMARY
            echo "momentum_scalper_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ momentum_scalper FAILED" >> $GITHUB_STEP_SUMMARY
            echo "momentum_scalper_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§ª Run range_breakout regression test
        id: range_breakout
        run: |
          echo "## ğŸ¯ range_breakout Strategy" >> $GITHUB_STEP_SUMMARY
          OUTPUT=$(./target/release/crypto-strategies optimize --config configs/range_breakout_config.json --top 1 2>&1) || true
          echo '`' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '`' >> $GITHUB_STEP_SUMMARY
          if echo "$OUTPUT" | grep -q "already optimal"; then
            echo "âœ… range_breakout PASSED" >> $GITHUB_STEP_SUMMARY
            echo "range_breakout_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ range_breakout FAILED" >> $GITHUB_STEP_SUMMARY
            echo "range_breakout_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§ª Run volatility_regime regression test
        id: volatility_regime
        run: |
          echo "## ğŸ¯ volatility_regime Strategy" >> $GITHUB_STEP_SUMMARY
          OUTPUT=$(./target/release/crypto-strategies optimize --config configs/volatility_regime_config.json --top 1 2>&1) || true
          echo '`' >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '`' >> $GITHUB_STEP_SUMMARY
          if echo "$OUTPUT" | grep -q "already optimal"; then
            echo "âœ… volatility_regime PASSED" >> $GITHUB_STEP_SUMMARY
            echo "volatility_regime_status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ volatility_regime FAILED" >> $GITHUB_STEP_SUMMARY
            echo "volatility_regime_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Summary Report
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Regression Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Strategy | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| regime_grid | ${{ steps.regime_grid.outputs.regime_grid_status == 'passed' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| quick_flip | ${{ steps.quick_flip.outputs.quick_flip_status == 'passed' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| momentum_scalper | ${{ steps.momentum_scalper.outputs.momentum_scalper_status == 'passed' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| range_breakout | ${{ steps.range_breakout.outputs.range_breakout_status == 'passed' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| volatility_regime | ${{ steps.volatility_regime.outputs.volatility_regime_status == 'passed' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Fail if any regression test failed
        if: |
          steps.regime_grid.outputs.regime_grid_status != 'passed' ||
          steps.quick_flip.outputs.quick_flip_status != 'passed' ||
          steps.momentum_scalper.outputs.momentum_scalper_status != 'passed' ||
          steps.range_breakout.outputs.range_breakout_status != 'passed' ||
          steps.volatility_regime.outputs.volatility_regime_status != 'passed'
        run: |
          echo "::error::One or more regression tests failed!"
          exit 1

  lint-and-test:
    name: ğŸ” Lint & Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - name: ğŸ“¦ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: ğŸ“ Check formatting
        run: cargo fmt --all -- --check

      - name: ğŸ” Run Clippy lints
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: ğŸ§ª Run unit tests
        run: cargo test --lib --verbose

      - name: ğŸ§ª Run integration tests
        run: cargo test --test '*' --verbose || true
